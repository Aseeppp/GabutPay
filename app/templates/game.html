{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    :root {
        --rarity-biasa: #7f8c8d;
        --rarity-lumayan: #3498db;
        --rarity-langka: #f1c40f;
        --rarity-legendaris: #e67e22;
    }

    .gacha-body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
        overflow: hidden;
        position: relative;
        background: linear-gradient(315deg, #1e272e, #34495e, #2c3e50);
        background-size: 400% 400%;
        animation: gradient-bg 15s ease infinite;
    }

    @keyframes gradient-bg {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .light-orb {
        position: absolute;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(52, 152, 219, 0.2) 0%, rgba(52, 152, 219, 0) 70%);
        border-radius: 50%;
        animation: float 20s infinite ease-in-out;
    }
    .light-orb.orb-1 { top: 10%; left: 10%; animation-delay: 0s; }
    .light-orb.orb-2 { bottom: 10%; right: 10%; animation-delay: 5s; }
    .light-orb.orb-3 { top: 50%; right: 20%; animation-delay: 10s; width: 100px; height: 100px; }

    @keyframes float {
        0%, 100% { transform: translateY(0) translateX(0); }
        50% { transform: translateY(-30px) translateX(20px); }
    }

    .gacha-container {
        padding: 2rem;
        text-align: center;
        perspective: 1000px;
        z-index: 1;
    }

    #chest-area {
        position: relative;
        width: 200px;
        height: 180px;
        margin: 2rem auto;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    #chest-area:hover { transform: scale(1.1); }
    #chest-area.disabled { pointer-events: none; filter: grayscale(80%); }

    /* Aura Animations */
    #chest-area.aura-Lumayan { animation: aura-pulse 1.5s infinite alternate; --aura-color: var(--rarity-lumayan); }
    #chest-area.aura-Langka { animation: aura-pulse 1s infinite alternate; --aura-color: var(--rarity-langka); }
    #chest-area.aura-Legendaris { animation: aura-pulse 0.5s infinite alternate; --aura-color: var(--rarity-legendaris); }

    @keyframes aura-pulse {
        from { box-shadow: 0 0 20px -5px var(--aura-color), 0 0 5px inset var(--aura-color); }
        to { box-shadow: 0 0 40px 10px var(--aura-color), 0 0 10px inset var(--aura-color); }
    }


    .chest {
        position: absolute;
        width: 100%;
        height: 100%;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }
    #chest-base { background-image: url('https://i.imgur.com/yHnK622.png'); z-index: 1; }
    #chest-lid { background-image: url('https://i.imgur.com/yHnK622.png'); transform-origin: bottom; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 3; }
    #chest-glow { background-image: url('https://i.imgur.com/2v51J5v.png'); z-index: 2; opacity: 0; transition: opacity 0.5s ease; }

    .chest-shaking { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) infinite; }
    .lid-opening { transform: rotateX(-110deg); }
    .glow-visible { opacity: 1; }

    @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    #result-area {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .prize-card {
        width: 250px;
        height: 180px;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: none;
        transform: translateZ(-200px) scale(0.5);
        opacity: 0;
    }
    .prize-card.visible {
        display: block;
        animation: fly-in 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
    }
    @keyframes fly-in {
        to {
            transform: translateZ(0) scale(1);
            opacity: 1;
        }
    }
    .prize-card.flipped { transform: translateZ(0) scale(1) rotateY(180deg); }

    .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        padding: 20px;
    }
    .card-front { background: #4a69bd; color: white; font-family: 'Press Start 2P', cursive; font-size: 24px; }
    .card-back { transform: rotateY(180deg); color: #333; }

    .rarity-Biasa { background: #bdc3c7; }
    .rarity-Lumayan { background: #3498db; color: white; }
    .rarity-Langka { background: #f1c40f; }
    .rarity-Legendaris {
        background: linear-gradient(45deg, #ffc107, #f39c12, #e67e22);
        color: white;
        animation: legendary-card-glow 1.5s infinite alternate;
    }
    @keyframes legendary-card-glow {
        from { box-shadow: 0 0 15px #ffc107, 0 0 5px white inset; }
        to { box-shadow: 0 0 30px #e67e22, 0 0 10px white inset; }
    }

    #prize-name { font-size: 1.5rem; font-weight: bold; }
    #prize-rarity { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    #prize-reward { font-size: 1rem; }
    #action-button { margin-top: 1rem; }

    /* --- Celebration Effects --- */
    #celebration-container {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        overflow: hidden;
        pointer-events: none;
        z-index: 10;
    }
    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #f1c40f;
        opacity: 0;
        animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
        0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
        100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="gacha-body">
    <div class="light-orb orb-1"></div>
    <div class="light-orb orb-2"></div>
    <div class="light-orb orb-3"></div>
    <div id="celebration-container"></div>

    <div class="gacha-container" data-play-url="{{ url_for('game.play_gacha') }}">
        <h1 class="mb-1 text-body-emphasis">Gacha Gabut</h1>
        <p class="lead text-muted mb-4">Peti apa yang akan kamu dapatkan?</p>

        <div id="chest-area">
            <div id="chest-glow" class="chest"></div>
            <div id="chest-lid" class="chest"></div>
            <div id="chest-base" class="chest"></div>
        </div>

        <div id="result-area">
            <div id="prize-card" class="prize-card">
                <div class="card-face card-front">?</div>
                <div class="card-face card-back">
                    <span id="prize-rarity" class="badge"></span>
                    <p id="prize-name" class="mb-1"></p>
                    <p id="prize-reward" class="mb-0"></p>
                </div>
            </div>
        </div>

        <div id="action-button">
             <button id="play-gacha-btn" class="btn btn-primary btn-lg">
                Buka Peti (Rp {{ (gacha_cost / 100) | int }})
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/game.js') }}"></script>
{% endblock %}
